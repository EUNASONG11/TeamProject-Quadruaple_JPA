<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.green.project_quadruaple.businessmypage.BusinessMyPageMapper">

    <resultMap id="bookingResultMap" type="com.green.project_quadruaple.businessmypage.model.BusinessMyPageBooking">
        <result property="bookingId" column="booking_id"/>
        <result property="title" column="title"/>
        <result property="strfId" column="strf_id"/>
        <result property="picName" column="pic_name"/>
        <result property="checkIn" column="check_in"/>
        <result property="checkOut" column="check_out"/>
        <result property="finalPayment" column="final_payment"/>
        <result property="state" column="state"/>
    </resultMap>

    <select id="selBookingByBusiness" resultMap="bookingResultMap">
          WITH RankedPhotos AS (
        SELECT D.strf_id, D.pic_name, ROW_NUMBER() OVER (PARTITION BY D.strf_id ORDER BY D.pic_name) AS rn
          FROM strf_pic D
        )
        SELECT A.booking_id, C.strf_id, C.title, RP.pic_name, A.check_in, A.check_out, A.final_payment, A.state
          FROM booking A
          LEFT JOIN menu B
            ON A.menu_id = B.menu_id
          LEFT JOIN stay_tour_restaur_fest C
            ON B.strf_id = C.strf_id
          LEFT JOIN RankedPhotos RP
            ON C.strf_id = RP.strf_id AND RP.rn = 1
          LEFT JOIN business_num E
            ON C.busi_num = E.busi_num
          LEFT JOIN user F
            ON E.user_id = F.user_id
         WHERE F.user_id = #{userId}
    </select>

    <select id="selBookingDetails">
        SELECT
        B.title AS menu_title, C.room_num, A.check_in, A.check_out, A.num AS booking_num, D.name, D.tell, E.email, A.final_payment, H.title AS coupon_title,
        I.recom_capacity,
        I.max_capacity,
        CASE
        WHEN A.num > I.recom_capacity AND A.num <![CDATA[<=]]> I.max_capacity
        THEN A.num - I.recom_capacity
        ELSE 0
        END AS extra_person_count
        FROM booking A
        LEFT JOIN menu B ON A.menu_id = B.menu_id
        LEFT JOIN room C ON A.room_id = C.room_id
        LEFT JOIN user D ON A.user_id = D.user_id
        LEFT JOIN authentication_code E ON D.authenticated_id = E.authenticated_id
        LEFT JOIN used_coupon F ON A.booking_id = F.booking_id
        LEFT JOIN receive_coupon G ON F.receive_id = G.receive_id
        LEFT JOIN coupon H ON G.coupon_id = H.coupon_id
        LEFT JOIN parlor I ON A.menu_id = I.menu_id
        WHERE A.booking_id = #{bookingId}
        AND A.num <![CDATA[<=]]> I.max_capacity
    </select>

</mapper>
