<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.green.project_quadruaple.chat.repository.ChatRoomMapper">

    <select id="selChatRoomList">
        SELECT
            cr.chat_room_id
            , cr.title AS title
            , latest_chat.speaker_id as
            , max(latest_chat.max_at) AS lastChatTimeLDT
            , count(crc.chat_id) AS unreadChat
        FROM chat_room cr
        JOIN chat_join cj
            ON cr.chat_room_id = cj.chat_room_id
        LEFT JOIN (
                SELECT
                c1.speaker_id
                , c1.content
                , c1.chat_id
                , c1.created_at AS max_at
            FROM chat c1
            JOIN (
            SELECT
                speaker_id
                , max(created_at) AS max_at
            FROM chat
            GROUP BY speaker_id
        ) latest_at
            ON latest_at.speaker_id = c1.speaker_id
            AND latest_at.max_at = c1.created_at
        ) latest_chat
            ON latest_chat.speaker_id = cj.cj_id
        LEFT JOIN chat_receive crc
            ON crc.listener_id = latest_chat.speaker_id
        WHERE cj.user_id = #{signedUserId}
        GROUP BY cr.chat_room_id
        ORDER BY latest_chat.max_at DESC
    </select>
</mapper>